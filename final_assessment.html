<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnBuddy â€” Final Assessment</title>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4dabf7;
            --darkblue: #1E3A8A;
            --card-bg: #f0f8ff;
            --light-gray: #f8f9fa;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f97316;
        }
        /* Your existing CSS styles */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background: #fff;
            color: var(--darkblue);
        }
        /* Rest of your CSS remains the same */
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-message {
            text-align: center;
            padding: 30px;
            color: var(--danger);
        }
        .retry-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <lottie-player src="{{ url_for('static', filename='lottie/girl.json') }}" background="transparent" speed="1" style="width:40px;height:40px;" loop autoplay></lottie-player>
            <div class="logo">LearnBuddy</div>
        </div>
        <div class="tagline">Personalized learning, simplified</div>
    </div>
    <div class="container">
        <h1>Final Assessment</h1>
        <div class="user-info">
            <div class="info-card">
                <div class="info-label">Subject</div>
                <div class="info-value" id="display-subject">Loading...</div>
            </div>
            <div class="info-card">
                <div class="info-label">Grade</div>
                <div class="info-value" id="display-grade">Loading...</div>
            </div>
            <div class="info-card">
                <div class="info-label">Learner Level</div>
                <div class="info-value" id="display-learner-level">Loading...</div>
            </div>
        </div>
        <div class="quiz-container" id="quiz-container">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading your personalized assessment...</p>
            </div>
        </div>
        <button class="btn-submit" id="submit-quiz" disabled>
            <i class="fas fa-paper-plane"></i> Submit Assessment
        </button>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBY3vXosHcqGT1T6Jo4-0QhkusmM5a0Cyo",
            authDomain: "learnbuddy-c0f4b.firebaseapp.com",
            projectId: "learnbuddy-c0f4b",
            storageBucket: "learnbuddy-c0f4b.appspot.com",
            messagingSenderId: "658794807805",
            appId: "1:658794807805:web:319bc7ddee319359149994",
            measurementId: "G-3CMN5FG3GQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variable to store quiz data and user data
        let quizData = {};
        let userData = {};
        let userId = '';

        document.addEventListener('DOMContentLoaded', function() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = "{{ url_for('login') }}";
                    return;
                }

                userId = user.uid;

                try {
                    // 1. Fetch user data from Firestore
                    const userSnap = await getDoc(doc(db, "users", userId));
                    if (!userSnap.exists()) throw new Error("User data not found");

                    userData = userSnap.data();
                    console.log("User data from Firebase:", userData);

                    // 2. Display user info with fallback values
                    const subject = userData.subject || "Science";
                    const grade = userData.grade || "10";

                    $("#display-subject").text(subject);
                    $("#display-grade").text(grade);

                    // Determine learner type
                    let learnerType = userData.learnerType || "Intermediate Learner";
                    if (!userData.learnerType && userData.score) {
                        if (userData.score <= 40) learnerType = "Slow Learner";
                        else if (userData.score <= 75) learnerType = "Intermediate Learner";
                        else learnerType = "Fast Learner";
                    }
                    $("#display-learner-level").text(learnerType);

                    // 3. Show loading state with the actual subject and grade
                    $(".loading-spinner p").text(`Generating your ${subject} assessment for Grade ${grade}...`);

                    // 4. Generate quiz with user's actual subject and grade
                    const response = await fetch("/generate-final-assessment", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            subject: subject,
                            grade: grade,
                            learner_type: learnerType
                        })
                    });

                    if (!response.ok) throw new Error("Failed to generate quiz");

                    quizData = await response.json();
                    renderQuiz(quizData);
                    $("#submit-quiz").prop("disabled", false);

                } catch (error) {
                    console.error("Error loading assessment:", error);
                    showError("Failed to load your personalized assessment. Please try again.");
                }

                // Submit quiz handler
                $("#submit-quiz").click(async function() {
                    const userAnswers = {};
                    $(".option input[type='radio']:checked").each(function() {
                        const questionNumber = $(this).attr("name").replace("q", "");
                        userAnswers[questionNumber] = parseInt($(this).val());
                    });

                    // Validate all questions are answered
                    if (Object.keys(userAnswers).length < quizData.questions.length) {
                        alert(`Please answer all ${quizData.questions.length} questions before submitting.`);
                        return;
                    }

                    // Disable button and show loading
                    $(this).prop("disabled", true).html(`
                        <div class="spinner" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"></div>
                        Submitting...
                    `);

                    try {
                        const result = await fetch("/submit-final-assessment", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                user_id: userId,
                                user_answers: userAnswers,
                                quiz_data: quizData
                            })
                        });

                        if (!result.ok) {
                            throw new Error("Failed to submit assessment");
                        }

                        const resultData = await result.json();
                        console.log("Assessment result:", resultData);

                        // Update Firestore with new score and assessment details
                        await setDoc(doc(db, "users", userId), {
                            score: resultData.score,
                            lastAssessment: new Date(),
                            subject: userData.subject,
                            grade: userData.grade,
                            lastAssessmentDetails: {
                                subject: quizData.subject,
                                grade: quizData.grade,
                                score: resultData.score,
                                total: resultData.total_questions,
                                percentage: resultData.percentage_score,
                                timestamp: new Date()
                            }
                        }, { merge: true });

                        // Redirect to report with all parameters
                        window.location.href = `/report?
                            score=${resultData.score}&
                            total=${resultData.total_questions}&
                            subject=${encodeURIComponent(quizData.subject)}&
                            grade=${quizData.grade}&
                            percentage=${resultData.percentage_score}`;
                    } catch (error) {
                        console.error("Submission error:", error);
                        $(this).prop("disabled", false).html('<i class="fas fa-paper-plane"></i> Submit Assessment');
                        showError("Error submitting assessment. Please try again.");
                    }
                });

                // Render quiz function
                function renderQuiz(data) {
                    quizData = data;
                    let quizHTML = `
                        <h2 style="text-align: center; margin-bottom: 30px; color: var(--darkblue);">
                            <i class="fas fa-clipboard-list"></i> ${data.quiz_title}
                        </h2>
                        <div style="text-align: center; margin-bottom: 20px; color: var(--text-light);">
                            Subject: <strong>${data.subject}</strong> |
                            Grade: <strong>${data.grade}</strong> |
                            ${data.questions.length} Questions
                        </div>
                    `;

                    data.questions.forEach((q, index) => {
                        quizHTML += `
                            <div class="question" style="animation-delay: ${index * 0.1}s;">
                                <div class="question-header">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Question ${q.question_number}: ${q.question_text}</span>
                                </div>
                                <ul class="options">
                                    ${q.options.map((opt, i) =>
                                        `<li class="option">
                                            <input type="radio" name="q${q.question_number}"
                                                   value="${i}" id="q${q.question_number}_${i}">
                                            <label for="q${q.question_number}_${i}">${opt}</label>
                                        </li>`
                                    ).join("")}
                                </ul>
                            </div>
                        `;
                    });

                    $("#quiz-container").html(quizHTML);
                }

                // Show error message
                function showError(message) {
                    $("#quiz-container").html(`
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>${message}</h3>
                            <button class="retry-btn" id="retry-btn">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `);

                    $("#retry-btn").click(function() {
                        location.reload();
                    });
                }
            });
        });
    </script>
</body>
</html>
